<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EPL Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f7f7;
      }
      .card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.06);
        border-radius: 0.75rem;
      }
      .table-container {
        max-height: 500px;
        overflow-y: auto;
      }
      th {
        position: sticky;
        top: 0;
        background: #1f2937;
        color: white;
        z-index: 10;
      }
      .tab-button {
        transition: all 0.3s ease;
      }
      .tab-button.active {
        background-color: #2563eb;
        color: white;
      }
      .tab-button.inactive {
        background-color: #e5e7eb;
        color: #6b7280;
      }
    </style>
  </head>
  <body class="p-4 md:p-10">
    <div class="container mx-auto">
      <h1 class="text-4xl font-bold text-gray-900 mb-2 text-center">
        EPL Predictor
      </h1>
      <p class="text-center text-gray-600 mb-10">
        FastAPI with ML Predictions and Chart.js Visualization.
      </p>

      <!-- Prediction Panel -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
        <!-- Prediction Form -->
        <div class="lg:col-span-1 p-6 bg-white card">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">
            Predict Match Result
          </h2>

          <div class="space-y-4">
            <!-- Home Team Select -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Home Team</label
              >
              <select
                id="homeTeam"
                onchange="updateTeamForm('home')"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">Select Home Team</option>
              </select>
              <div
                id="homeFormDisplay"
                class="mt-2 p-3 bg-blue-50 rounded-md text-sm text-blue-800 hidden"
              >
                <span class="font-medium">Current Form: </span
                ><span id="homeFormValue">-</span> pts
              </div>
            </div>

            <!-- Away Team Select -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Away Team</label
              >
              <select
                id="awayTeam"
                onchange="updateTeamForm('away')"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">Select Away Team</option>
              </select>
              <div
                id="awayFormDisplay"
                class="mt-2 p-3 bg-red-50 rounded-md text-sm text-red-800 hidden"
              >
                <span class="font-medium">Current Form: </span
                ><span id="awayFormValue">-</span> pts
              </div>
            </div>

            <!-- Hidden inputs to store form points -->
            <input type="hidden" id="homePts" value="0" />
            <input type="hidden" id="awayPts" value="0" />

            <button
              onclick="getPrediction()"
              class="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
              id="predictButton"
              disabled
            >
              Get Prediction
            </button>

            <div
              id="predictionOutput"
              class="mt-4 p-4 text-center rounded-md bg-gray-50 border border-gray-200 hidden"
            >
              <p
                class="text-lg font-bold text-gray-800"
                id="finalPrediction"
              ></p>
            </div>
            <div
              id="errorMessage"
              class="mt-4 p-2 text-center rounded-md bg-red-100 text-red-700 border border-red-300 hidden"
            ></div>
          </div>
        </div>

        <!-- Prediction Visualization -->
        <div class="lg:col-span-2 p-6 bg-white card">
          <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">
            Prediction Visualization
          </h2>
          <div class="h-96">
            <canvas id="predictionChart"></canvas>
          </div>
        </div>
      </div>

      <!-- League Tables & Predictions Panel -->
      <div class="p-6 bg-white card mb-12">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">
          League Standings
        </h2>

        <!-- Tab Navigation -->
        <div class="flex gap-2 mb-6 flex-wrap">
          <button
            onclick="switchTab('current')"
            id="tab-current"
            class="tab-button active px-4 py-2 rounded-md font-medium text-sm"
          >
            Current Table
          </button>
          <button
            onclick="switchTab('predicted')"
            id="tab-predicted"
            class="tab-button inactive px-4 py-2 rounded-md font-medium text-sm"
          >
            End-of-Season Prediction
          </button>
        </div>

        <!-- Current Table Tab -->
        <div id="current-tab" class="table-container shadow-md rounded-lg">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-800 text-white">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  Pos
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  Team
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  P
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  Pts
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  GD
                </th>
              </tr>
            </thead>
            <tbody
              id="leagueTableBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Data will be inserted here by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Predicted Table Tab -->
        <div
          id="predicted-tab"
          class="hidden table-container shadow-md rounded-lg"
        >
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-800 text-white">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  Projected Pos
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  Team
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  Projected Pts
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider"
                >
                  Games
                </th>
              </tr>
            </thead>
            <tbody
              id="predictedTableBody"
              class="bg-white divide-y divide-gray-200"
            >
              <!-- Data will be inserted here by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Error/Info Messages -->
        <div
          id="predictionTableError"
          class="mt-4 p-4 text-center rounded-md bg-yellow-100 text-yellow-700 border border-yellow-300 hidden"
        >
          No end-of-season predictions available. Run the training script with
          the prediction module enabled.
        </div>
      </div>

      <!-- Prediction Quality Info -->
      <div class="p-6 bg-blue-50 border border-blue-200 rounded-lg card mb-12">
        <h3 class="text-lg font-semibold text-blue-900 mb-2">
          Model Information
        </h3>
        <p class="text-blue-800 text-sm">
          The end-of-season predictions use a machine learning model trained on
          historical EPL data and current season matches. The model simulates
          remaining fixtures and predicts outcomes based on team form (points
          from last 5 matches). Predictions become more accurate as more matches
          are played in the current season.
        </p>
      </div>
    </div>

    <script>
      const API_BASE = window.location.origin;
      let predictionChart;
      let currentTab = "current";
      let teamsData = []; // Store teams and their form data

      document.addEventListener("DOMContentLoaded", () => {
        fetchTableData();
        fetchPredictedTableData();
        initializeChart();
      });

      // --- Tab Switching ---
      function switchTab(tab) {
        currentTab = tab;

        // Hide all tabs
        document.getElementById("current-tab").classList.add("hidden");
        document.getElementById("predicted-tab").classList.add("hidden");

        // Reset all buttons
        document.getElementById("tab-current").classList.remove("active");
        document.getElementById("tab-current").classList.add("inactive");
        document.getElementById("tab-predicted").classList.remove("active");
        document.getElementById("tab-predicted").classList.add("inactive");

        // Show selected tab and activate button
        if (tab === "current") {
          document.getElementById("current-tab").classList.remove("hidden");
          document.getElementById("tab-current").classList.add("active");
          document.getElementById("tab-current").classList.remove("inactive");
        } else {
          document.getElementById("predicted-tab").classList.remove("hidden");
          document.getElementById("tab-predicted").classList.add("active");
          document.getElementById("tab-predicted").classList.remove("inactive");
        }
      }

      // --- Chart.js Initialization ---
      function initializeChart() {
        const ctx = document.getElementById("predictionChart").getContext("2d");
        predictionChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Home Win", "Draw", "Away Win"],
            datasets: [
              {
                label: "Probability",
                data: [0, 0, 0],
                backgroundColor: [
                  "rgba(59, 130, 246, 0.7)",
                  "rgba(245, 158, 11, 0.7)",
                  "rgba(239, 68, 68, 0.7)",
                ],
                borderColor: [
                  "rgba(59, 130, 246, 1)",
                  "rgba(245, 158, 11, 1)",
                  "rgba(239, 68, 68, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 1.0,
                title: {
                  display: true,
                  text: "Probability",
                },
              },
            },
            plugins: {
              legend: { display: false },
              title: { display: true, text: "Match Outcome Probability" },
            },
          },
        });
      }

      // --- Data Fetching Functions ---
      async function fetchTableData() {
        const tableBody = document.getElementById("leagueTableBody");
        tableBody.innerHTML =
          '<tr><td colspan="5" class="text-center py-4 text-gray-500">Loading table data...</td></tr>';
        try {
          const response = await fetch(`/api/current-table`);
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const data = await response.json();

          tableBody.innerHTML = "";
          teamsData = data; // Store teams data for form calculations

          // Populate team select dropdowns
          populateTeamSelects(data);

          data.forEach((row) => {
            const tr = document.createElement("tr");
            tr.className =
              "hover:bg-gray-50 transition duration-150 ease-in-out";
            tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.position}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.team}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.played}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold">${row.points}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.gd}</td>
                    `;
            tableBody.appendChild(tr);
          });
        } catch (error) {
          console.error("Error fetching table data:", error);
          tableBody.innerHTML =
            '<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load table. Is FastAPI running?</td></tr>';
        }
      }

      // --- Populate Team Select Dropdowns ---
      function populateTeamSelects(data) {
        const homeSelect = document.getElementById("homeTeam");
        const awaySelect = document.getElementById("awayTeam");

        // Clear existing options except the first one
        homeSelect.innerHTML = '<option value="">Select Home Team</option>';
        awaySelect.innerHTML = '<option value="">Select Away Team</option>';

        data.forEach((team) => {
          const homeOption = document.createElement("option");
          homeOption.value = team.team;
          homeOption.textContent = team.team;
          homeSelect.appendChild(homeOption);

          const awayOption = document.createElement("option");
          awayOption.value = team.team;
          awayOption.textContent = team.team;
          awaySelect.appendChild(awayOption);
        });
      }

      // --- Update Team Form Display ---
      function updateTeamForm(side) {
        const teamSelect =
          side === "home"
            ? document.getElementById("homeTeam")
            : document.getElementById("awayTeam");
        const formDisplay = document.getElementById(`${side}FormDisplay`);
        const formValue = document.getElementById(`${side}FormValue`);
        const ptsInput = document.getElementById(`${side}Pts`);
        const predictButton = document.getElementById("predictButton");

        const selectedTeam = teamSelect.value;

        if (!selectedTeam) {
          formDisplay.classList.add("hidden");
          ptsInput.value = 0;
          predictButton.disabled = true;
          return;
        }

        // Find team in teamsData and calculate form (use points as proxy for form)
        const team = teamsData.find((t) => t.team === selectedTeam);
        if (team) {
          // Using total points as form proxy (you can replace with actual last 5 match calculation)
          const teamForm = team.points;
          formValue.textContent = teamForm;
          ptsInput.value = teamForm;
          formDisplay.classList.remove("hidden");
        }

        // Enable button only if both teams are selected
        const homeTeam = document.getElementById("homeTeam").value;
        const awayTeam = document.getElementById("awayTeam").value;
        predictButton.disabled =
          !homeTeam || !awayTeam || homeTeam === awayTeam;
      }

      async function fetchPredictedTableData() {
        const tableBody = document.getElementById("predictedTableBody");
        const errorDiv = document.getElementById("predictionTableError");

        try {
          const response = await fetch(
            `${API_BASE}/predictions/epl_end_of_season_predictions.csv`
          );

          if (!response.ok) {
            errorDiv.classList.remove("hidden");
            tableBody.innerHTML =
              '<tr><td colspan="4" class="text-center py-4 text-gray-500">No predictions available yet</td></tr>';
            return;
          }

          const csvText = await response.text();
          const lines = csvText.trim().split("\n");
          const headers = lines[0].split(",");

          tableBody.innerHTML = "";
          let position = 1;

          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(",");
            const team = values[0];
            const predictedPoints = values[1];
            const gamesPlayed = values[2];

            const tr = document.createElement("tr");
            tr.className =
              "hover:bg-blue-50 transition duration-150 ease-in-out";
            tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${position}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${team}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-bold">${predictedPoints}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${gamesPlayed}</td>
                    `;
            tableBody.appendChild(tr);
            position++;
          }

          errorDiv.classList.add("hidden");
        } catch (error) {
          console.error("Error fetching predicted table data:", error);
          errorDiv.classList.remove("hidden");
          tableBody.innerHTML =
            '<tr><td colspan="4" class="text-center py-4 text-gray-500">No predictions available yet</td></tr>';
        }
      }

      async function getPrediction() {
        const homeTeam = document.getElementById("homeTeam").value;
        const awayTeam = document.getElementById("awayTeam").value;
        const homePts = document.getElementById("homePts").value;
        const awayPts = document.getElementById("awayPts").value;
        const outputDiv = document.getElementById("predictionOutput");
        const finalPredictionP = document.getElementById("finalPrediction");
        const errorDiv = document.getElementById("errorMessage");

        outputDiv.classList.add("hidden");
        errorDiv.classList.add("hidden");

        try {
          const url = `${API_BASE}/api/predict?home_team=${encodeURIComponent(
            homeTeam
          )}&away_team=${encodeURIComponent(awayTeam)}`;

          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              home_pts_last_5: parseInt(homePts),
              away_pts_last_5: parseInt(awayPts),
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(
              data.detail || `Prediction failed with status: ${response.status}`
            );
          }

          const labels = Object.keys(data.probabilities);
          const values = labels.map((key) => data.probabilities[key]);

          predictionChart.data.labels = labels;
          predictionChart.data.datasets[0].data = values;
          predictionChart.options.plugins.title.text = `${homeTeam} vs ${awayTeam} Prediction`;
          predictionChart.update();

          finalPredictionP.textContent = `Predicted Outcome: ${
            data.prediction
          } (${(data.probabilities[data.prediction] * 100).toFixed(1)}%)`;
          outputDiv.classList.remove("hidden");
        } catch (error) {
          console.error("Prediction Error:", error);
          errorDiv.textContent = `Error: ${error.message}. Ensure the ML model is trained and running.`;
          errorDiv.classList.remove("hidden");
        }
      }
    </script>
  </body>
</html>
