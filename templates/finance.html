<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Financial Market Analytics</title>
    <head>
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
      />
    </head>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
            colors: {
              "finance-primary": "#1e3a8a", // Deep Indigo 800
              "finance-accent": "#3b82f6", // Blue 500
            },
          },
        },
      };
    </script>
    <style>
      /* Custom styles for Chart containers */
      .chart-container {
        max-width: 100%;
        height: 400px; /* Slightly taller chart */
        margin-top: 1.5rem;
      }
      /* Style for Lucide icons */
      .lucide {
        width: 1.25rem;
        height: 1.25rem;
        stroke-width: 2.5;
      }
      /* Style for the segmented button control (No longer used) */
      .time-filter button.active {
        background-color: var(--tw-colors-finance-accent);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -2px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans p-4 sm:p-8">
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        collection,
        query,
        onSnapshot,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Global Variables (Provided by Canvas) ---
      const firebaseConfig =
        typeof __firebase_config !== "undefined"
          ? JSON.parse(__firebase_config)
          : null;
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      let app, db, auth;
      let userId = "loading...";

      if (firebaseConfig) {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Authentication and User ID Setup
        if (initialAuthToken) {
          signInWithCustomToken(auth, initialAuthToken)
            .then((userCredential) => {
              userId = userCredential.user.uid;
              document.getElementById("user-id").textContent = userId;
              console.log("Authenticated with custom token.");
            })
            .catch((error) => {
              console.error("Error signing in with custom token:", error);
            });
        } else {
          signInAnonymously(auth)
            .then((userCredential) => {
              userId = userCredential.user.uid;
              document.getElementById("user-id").textContent = userId;
              console.log("Signed in anonymously.");
            })
            .catch((error) => {
              console.error("Error signing in anonymously:", error);
            });
        }
      } else {
        document.getElementById("user-id").textContent = "N/A (Local)";
        console.warn(
          "Firebase configuration not found. Running in local mode."
        );
      }

      // Initialize Lucide icons
      lucide.createIcons();
    </script>

    <div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
      <header class="pb-6 border-b border-gray-200">
        <h1
          class="text-3xl sm:text-4xl font-extrabold text-finance-primary flex items-center"
        >
          <i data-lucide="line-chart" class="mr-3 text-finance-accent"></i>
          Financial Market Analytics
        </h1>
        <p class="mt-2 text-lg text-gray-500">
          Machine learning-powered forecast and historical trend analysis for
          <span id="ticker-display" class="font-bold text-finance-primary"
            >GOOG</span
          >.
        </p>
      </header>

      <main class="mt-8">
        <div
          class="mb-8 flex flex-col sm:flex-row items-stretch sm:items-center space-y-4 sm:space-y-0 sm:space-x-4 p-4 bg-gray-50 rounded-lg border border-gray-200"
        >
          <label
            for="tickerSelect"
            class="text-gray-700 font-medium whitespace-nowrap"
            >Select Stock Ticker:</label
          >
          <select
            id="tickerSelect"
            class="p-2 border border-gray-300 bg-white rounded-lg focus:ring-finance-accent focus:border-finance-accent w-full sm:w-40 transition duration-150 uppercase"
          ></select>
        </div>

        <div
          id="summary-cards"
          class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10"
        >
          <div
            class="bg-white p-6 rounded-xl shadow-lg border border-finance-primary/20 transition hover:shadow-xl"
          >
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-gray-500">
                Current Price (Close)
              </p>
              <i data-lucide="dollar-sign" class="text-finance-primary/70"></i>
            </div>
            <p id="current-price" class="text-4xl font-bold text-gray-800 mt-2">
              --
            </p>
          </div>

          <div
            class="p-6 rounded-xl shadow-lg border border-finance-primary/20 transition hover:shadow-xl"
            id="forecast-card"
          >
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-gray-500">
                Next Day Forecast (ML)
              </p>
              <i data-lucide="trending-up" class="text-finance-accent"></i>
            </div>
            <p
              id="next-day-forecast"
              class="text-4xl font-bold text-gray-800 mt-2"
            >
              --
            </p>
          </div>

          <div
            class="p-6 rounded-xl shadow-lg border border-finance-primary/20 transition hover:shadow-xl"
            id="diff-card"
          >
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-gray-500">
                Predicted Change
              </p>
              <i data-lucide="minus" class="text-gray-500" id="diff-icon"></i>
            </div>
            <p
              id="price-difference"
              class="text-4xl font-bold text-gray-800 mt-2"
            >
              --
            </p>
          </div>
        </div>

        <div
          class="bg-white p-6 rounded-xl shadow-xl border border-gray-200 mb-10"
        >
          <h2 class="text-2xl font-semibold text-gray-800 mb-4">
            7-Day Price Forecast (ML)
          </h2>
          <div class="chart-container">
            <canvas id="forecastChart"></canvas>
          </div>
          <p class="mt-4 text-sm text-gray-500 text-yellow-600 font-medium">
            Note: The 7-day forecast data is currently simulated for
            visualization purposes. It should be supplied by the FastAPI
            backend.
          </p>
        </div>

        <div
          class="mt-10 bg-white p-6 rounded-xl shadow-xl border border-gray-200"
        >
          <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">
            Correlation Analysis
          </h2>
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Metric
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Close Price
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Volume
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  7-Day MA
                </th>
              </tr>
            </thead>
            <tbody
              id="correlation-body"
              class="bg-white divide-y divide-gray-100"
            >
              <tr>
                <td colspan="4" class="text-center py-4 text-gray-400">
                  Loading analysis...
                </td>
              </tr>
            </tbody>
          </table>
          <p class="mt-4 text-sm text-gray-500">
            Correlation values range from -1 (perfect negative) to +1 (perfect
            positive).
          </p>
        </div>

        <div
          id="loading"
          class="hidden fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"
        >
          <div
            class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-finance-accent"
          ></div>
          <p class="ml-4 text-finance-primary font-semibold">
            Loading data and generating analysis...
          </p>
        </div>
        <div
          id="error-message"
          class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"
        ></div>
      </main>
    </div>

    <script>
      let forecastChart; // Only keeping the forecast chart variable
      const TOP_TICKERS = ["GOOG", "MSFT", "AAPL", "TSLA", "AMZN"];
      // allHistoricalData and priceChart variables removed

      // Utility to format numbers as currency
      const formatter = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
      });

      const diffFormatter = new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        signDisplay: "always",
      });

      // --- Select List Population ---
      function populateTickerSelect() {
        const select = document.getElementById("tickerSelect");
        TOP_TICKERS.forEach((ticker) => {
          const option = document.createElement("option");
          option.value = ticker;
          option.textContent = ticker;
          select.appendChild(option);
        });
        select.addEventListener("change", (e) => {
          fetchAndDisplayData(e.target.value);
        });
      }

      // --- Time Filter Initialization (REMOVED) ---
      // initTimeFilters function removed

      // --- Data Filtering Logic (REMOVED) ---
      // filterAndDrawChart function removed

      // --- Forecast Chart Drawing Function (KEPT) ---
      function updateForecastChart(forecastData, currentPrice, ticker) {
        const ctx = document.getElementById("forecastChart").getContext("2d");

        // Generate labels and data (Day 0 is today's closing price)
        const dates = forecastData.map((d) => d.date);
        const prices = forecastData.map((d) => d.price);

        dates.unshift("Today");
        prices.unshift(currentPrice);

        // Destroy existing chart instance if it exists
        if (forecastChart) {
          forecastChart.destroy();
        }

        forecastChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: dates,
            datasets: [
              {
                label: `${ticker} Forecast`,
                data: prices,
                borderColor: "rgba(59, 130, 246, 1)", // finance-accent (Blue)
                backgroundColor: "rgba(59, 130, 246, 0.2)",
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: "rgba(59, 130, 246, 1)",
                fill: true,
                tension: 0.2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Time Horizon (Days)",
                  color: "#4b5563",
                },
                grid: { display: false },
              },
              y: {
                title: {
                  display: true,
                  text: "Predicted Price (USD)",
                  color: "#4b5563",
                },
                grid: { color: "rgba(0, 0, 0, 0.05)" },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false },
            },
          },
        });
      }

      // --- Historical Chart Drawing Function (REMOVED) ---
      // updateHistoricalChart function removed

      // --- Main Data Fetching Function (MODIFIED) ---
      async function fetchAndDisplayData(ticker) {
        const loading = document.getElementById("loading");
        const errorDiv = document.getElementById("error-message");
        loading.classList.remove("hidden");
        errorDiv.classList.add("hidden");

        // allHistoricalData reset logic removed

        try {
          const response = await fetch(`/api/finance/data/${ticker}`);
          const data = await response.json();

          if (!response.ok) {
            throw new Error(
              data.detail || `Failed to fetch data for ${ticker}.`
            );
          }

          // Historical data processing logic removed
          // allHistoricalData = data.historical_data.map((d) => ({ ... }));

          // 1. Update summary and correlation first
          updateSummaryCards(data);
          updateCorrelationTable(data.correlation_matrix);
          document.getElementById("ticker-display").textContent =
            ticker.toUpperCase();

          // 2. Draw the 7-Day Forecast Chart
          const currentPrice = data.current_price || 0;
          const forecastData = data.forecast_data || [];

          if (forecastData.length > 0) {
            updateForecastChart(forecastData, currentPrice, ticker);
          } else {
            console.warn("No forecast data received from backend for", ticker);
            updateForecastChart([], currentPrice, ticker);
          }

          // Historical chart drawing logic removed (filterAndDrawChart, defaultPeriod)
        } catch (error) {
          console.error("Analytics Error:", error);
          errorDiv.textContent = `Error: ${error.message}. Please ensure the ML training script has been run for ${ticker}.`;
          errorDiv.classList.remove("hidden");
          updateSummaryCards({ current_price: null, next_day_forecast: null });
          updateForecastChart([], 0, ticker); // Clear forecast chart on error
        } finally {
          loading.classList.add("hidden");
          lucide.createIcons();
        }
      }

      function updateSummaryCards(data) {
        const currentPrice = data.current_price;
        const forecast = data.next_day_forecast;
        const diffCard = document.getElementById("diff-card");
        const diffIcon = document.getElementById("diff-icon");

        document.getElementById("current-price").textContent = currentPrice
          ? formatter.format(currentPrice)
          : "--";
        document.getElementById("next-day-forecast").textContent = forecast
          ? formatter.format(forecast)
          : "--";

        // Reset card and icon classes
        diffCard.className =
          "p-6 rounded-xl shadow-lg border border-finance-primary/20 transition hover:shadow-xl";
        diffIcon.setAttribute("data-lucide", "minus");
        diffIcon.className = "text-gray-500 lucide";

        if (forecast && currentPrice) {
          const difference = forecast - currentPrice;
          const diffText = diffFormatter.format(difference);

          document.getElementById("price-difference").textContent = diffText;

          if (difference > 0.05) {
            // Positive prediction
            diffCard.classList.add("bg-green-50/50", "border-green-400");
            diffIcon.setAttribute("data-lucide", "arrow-up");
            diffIcon.className = "text-green-600 lucide";
          } else if (difference < -0.05) {
            // Negative prediction
            diffCard.classList.add("bg-red-50/50", "border-red-400");
            diffIcon.setAttribute("data-lucide", "arrow-down");
            diffIcon.className = "text-red-600 lucide";
          } else {
            // Neutral/Flat prediction
            diffCard.classList.add("bg-yellow-50/50", "border-yellow-400");
            diffIcon.setAttribute("data-lucide", "minus");
            diffIcon.className = "text-yellow-600 lucide";
          }
          // Lucide re-render call added here for the icons to update
          lucide.createIcons();
        } else {
          document.getElementById("price-difference").textContent = "--";
        }
      }

      function updateCorrelationTable(corrMatrix) {
        const tbody = document.getElementById("correlation-body");
        tbody.innerHTML = "";

        // Define rows and their source keys in the matrix
        const rows = [
          {
            name: "Price (Close)",
            key: "Close",
            target: "Close",
            volumeKey: "Volume",
            maKey: "MA_7",
          },
        ];

        rows.forEach((row) => {
          const closeToVolume = corrMatrix[row.key]
            ? corrMatrix[row.key][row.volumeKey]
            : "N/A";
          const closeToMA7 = corrMatrix[row.key]
            ? corrMatrix[row.key][row.maKey]
            : "N/A";

          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50";

          const cellMetric = document.createElement("td");
          cellMetric.className =
            "px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900";
          cellMetric.textContent = row.name;
          tr.appendChild(cellMetric);

          // Close Price (Target) correlation (always 1.00 for self)
          const cellClose = document.createElement("td");
          cellClose.className =
            "px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-bold";
          cellClose.textContent = "1.0000";
          tr.appendChild(cellClose);

          // Volume correlation
          const cellVolume = document.createElement("td");
          cellVolume.className =
            "px-6 py-4 whitespace-nowrap text-sm text-gray-600";
          cellVolume.textContent =
            typeof closeToVolume === "number" ? closeToVolume.toFixed(4) : "--";
          cellVolume.style.color = getCorrelationColor(
            typeof closeToVolume === "number" ? closeToVolume : 0
          );
          tr.appendChild(cellVolume);

          // MA_7 correlation
          const cellMA7 = document.createElement("td");
          cellMA7.className =
            "px-6 py-4 whitespace-nowrap text-sm text-gray-600";
          cellMA7.textContent =
            typeof closeToMA7 === "number" ? closeToMA7.toFixed(4) : "--";
          cellMA7.style.color = getCorrelationColor(
            typeof closeToMA7 === "number" ? closeToMA7 : 0
          );
          tr.appendChild(cellMA7);

          tbody.appendChild(tr);
        });
      }

      function getCorrelationColor(value) {
        if (value >= 0.8) return "var(--tw-colors-green-600)";
        if (value <= -0.8) return "var(--tw-colors-red-600)";
        if (Math.abs(value) >= 0.5) return "var(--tw-colors-yellow-600)";
        return "var(--tw-colors-gray-500)";
      }

      // --- Initial Load ---
      window.onload = () => {
        populateTickerSelect();
        // initTimeFilters removed
        fetchAndDisplayData("GOOG");
      };
    </script>
  </body>
</html>
